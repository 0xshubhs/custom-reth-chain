# Development Dockerfile for POA Node
# Uses `just dev` for live development with hot reloading capability
FROM rust:1.83-bookworm

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    clang \
    libclang-dev \
    pkg-config \
    libssl-dev \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install just command runner
RUN cargo install just

# Install cargo-watch for hot reloading (optional)
RUN cargo install cargo-watch

WORKDIR /app

# Copy project files
COPY Cargo.toml Cargo.lock* ./
COPY src ./src
COPY Justfile ./
COPY sample-genesis.json ./

# Pre-build dependencies to cache them
RUN cargo fetch

# Create data directory
RUN mkdir -p /app/data

# Expose ports
EXPOSE 8545 8546 30303 30303/udp 9001

# Set environment variables
ENV RUST_LOG=info
ENV RUST_BACKTRACE=1

# Default command - runs `just dev` which builds and runs the node
CMD ["just", "dev"]
